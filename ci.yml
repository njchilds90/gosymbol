name: CI
  
  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]
  
  jobs:
    test:
      name: Test (Go ${{ matrix.go }})
      runs-on: ubuntu-latest
      strategy:
        matrix:
          go: ["1.21", "1.22", "1.23"]
  
      steps:
        - uses: actions/checkout@v4
  
        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: ${{ matrix.go }}
  
        - name: Run tests
          run: go test -v -race ./...
  
        - name: Check formatting
          run: |
            if [ -n "$(gofmt -l .)" ]; then
              echo "The following files are not gofmt'd:"
              gofmt -l .
              exit 1
            fi
  
        - name: Vet
          run: go vet ./...
  
    coverage:
      name: Coverage
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
  
        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: "1.23"
  
        - name: Run tests with coverage
          run: go test -coverprofile=coverage.out ./...
  
        - name: Show coverage
          run: go tool cover -func=coverage.out